!function(e){"use strict";"function"==typeof AudioEye.define&&AudioEye.define.amd?AudioEye.define("lib/modals",["jquery","ae_options","lib/logger","shortcut","utilities"],e):e(window.$ae)}(function(e,t,i,o,r){"use strict";function a(t){e(document).off("keydown.remapilooptab"),e(document).on("keydown.remapilooptab",l),AudioEye.modals.refreshTabLoopHelperElements()}function n(){e(document).off("keydown.remapilooptab"),e(".tabloophelper").remove()}function l(t){if(!AudioEye.modals.tabLoopActive)return void AudioEye.modals.disableTabLoop();if(!r.isModuleActive("player")&&9==t.keyCode){var i=e(v.tabLoopContainer),o=t.target;if(!1!==(o=d(t,i,t.shiftKey)))if(t.shiftKey){var a,n=f(o,m,i),l=!1;if(!n){for(a=i[0].lastChild;a.lastChild;)a=a.lastChild;e(a).traverseDF({direction:"prev",limit:null},function(){if(n=m(e(this)))return"stop"})}if(n){if(0===n.closest(i[0]).length){l=!0;for(var a=i[0].lastChild;a.lastChild;)a=a.lastChild;e(a).traverseDF({direction:"prev",limit:null},function(){if(n=m(e(this)))return"stop"})}n.is("iframe")&&!r.isSearchableIframe(n)?AudioEye.modals.refreshTabLoopHelperElements("after",n):n.is("iframe")&&r.isSearchableIframe(n)?n.focus():(t.preventDefault(),n.focus()),l||!n.is("iframe")||r.isSearchableIframe(n)||AudioEye.modals.refreshTabLoopHelperElements("after",n)}}else{var u,n=s(o,m,i),l=!1;n||(u=i[0].firstChild,e(u).traverseDF({direction:"next",limit:null},function(){if(n=m(e(this)))return"stop"})),n&&(0===n.closest(i[0]).length&&(l=!0,u=i[0].firstChild,e(u).traverseDF({direction:"next",limit:null},function(){if(n=m(e(this)))return"stop"})),n.is("iframe")&&!r.isSearchableIframe(n)?AudioEye.modals.refreshTabLoopHelperElements("before",n):n.is("iframe")&&r.isSearchableIframe(n)||(t.preventDefault(),n.focus()),l||!n.is("iframe")||r.isSearchableIframe(n)||AudioEye.modals.refreshTabLoopHelperElements("before",n))}}}function s(t,i,o){var r,a=!1;if(t.firstChild)r=t.firstChild;else if(t.nextSibling)r=t.nextSibling;else for(r=t;r.parentElement;)if(r=r.parentElement,r.nextSibling){r=r.nextSibling;break}return e(r).traverseDF({direction:"next",limit:null},function(){if(a=i(e(this)))return"stop"}),a}function f(t,i,o){var r,a=!1;if(t.previousSibling)for(r=t.previousSibling;r.lastChild;)r=r.lastChild;else r=t.parentElement?t.parentElement:o;return e(r).traverseDF({direction:"prev",limit:null},function(){if(a=i(e(this)))return"stop"}),a}function d(t,i,o){var r=t.target;if(r===document&&e(r.activeElement).hasClass("tabloophelper"))r=t.target.activeElement;else if(r===document){if(r=t.target.activeElement,t.view){var a=AudioEye.modals.sourceIframe(t.view);a===r?r=!1:(r=document.activeElement,r=0!==e(a).closest(i[0]).length&&a)}}else if(0===e(r).closest(i[0]).length){var n=u(r,t.shiftKey);if(t.shiftKey&&n){var l=n.prev("iframe");AudioEye.modals.refreshTabLoopHelperElements("after",l)}else if(n){var s=n.next("iframe");AudioEye.modals.refreshTabLoopHelperElements("before",s)}h.debug("focus detected outside the modal container while tab loop is active"),r=!1}return r}function u(t,i){var o=e(AudioEye.modals.tabLoopContainer);if(i){var r,a=!1;if(t.previousSibling)for(r=t.previousSibling;r.lastChild;)r=r.lastChild;else r=t.parentElement?t.parentElement:o;return e(r).traverseDF({direction:"prev",limit:null},function(){if(a=c(e(this)))return"stop"}),!(!a||!a.hasClass("tabloophelperafter"))&&a}var n,a=!1;return n=t.firstChild?t.firstChild:t.nextSibling?t.nextSibling:o,e(n).traverseDF({direction:"next",limit:null},function(){if(a=c(e(this)))return"stop"}),!(!a||!a.hasClass("tabloophelperbefore"))&&a}function p(t){if(!AudioEye.modals.tabLoopActive)return void e(".tabloophelper").remove();if(r.isModuleActive("player"))return aeplayer.tabFocus.go("shift+tab"),void e(".tabloophelper").remove();var i=new window.Event("keydown");i.keyCode=9,i.shiftKey=!0,document.dispatchEvent(i)}function b(t){if(!AudioEye.modals.tabLoopActive)return void e(".tabloophelper").remove();if(r.isModuleActive("player"))return aeplayer.tabFocus.go("tab"),void e(".tabloophelper").remove();var i=new window.Event("keydown");i.keyCode=9,i.shiftKey=!1,document.dispatchEvent(i)}function c(e){return e.attr("style")&&e.attr("style").indexOf("visibility: hidden")>-1?null:e.is("iframe:visible")?e:e.filter(":tabbable").length>0?e:null}function m(e){return e.hasClass("tabloophelper")?null:e.attr("style")&&e.attr("style").indexOf("visibility: hidden")>-1?null:e.is("iframe:visible")?e:e.filter(":tabbable").length>0?e:null}var h=new i("modals"),v={tabLoopActive:!1,tabLoopContainer:"",enableTabLoop:function(e){if(!e)return void this.disableTabLoop();this.tabLoopActive=!0,this.tabLoopContainer=e,h.info("Tab loop enabled for container: "+e),a(e)},disableTabLoop:function(){h.info("disabling modal tab loop"),this.tabLoopActive=!1,n(this.container)},tabbingOutOfCrossOriginIframe:function(){var t=!1;return this.tabLoopActive&&(e(document.activeElement).hasClass("tabloophelperafter")&&(t=e(document.activeElement).prev("iframe"),0===t.length&&(t=!1)),e(document.activeElement).hasClass("tabloophelperbefore")&&(t=e(document.activeElement).next("iframe"),0===t.length&&(t=!1)),this.refreshTabLoopHelperElements()),t},refreshTabLoopHelperElements:function(t,i){e(".tabloophelper").remove(),e(this.tabLoopContainer).find("iframe:visible").each(function(){var o=e(this);o.attr("style")&&o.attr("style").indexOf("visibility: hidden")>-1||r.isSearchableIframe(o)||(o.after("<div tabindex='0' class='tabloophelper tabloophelperafter ae-compliance-indent ae-exclude'></div>"),o.before("<div tabindex='0' class='tabloophelper tabloophelperbefore ae-compliance-indent ae-exclude'></div> "),"before"===t&&o[0]===i[0]&&i.prev(".tabloophelper").focus(),"after"===t&&o[0]===i[0]&&i.next(".tabloophelper").focus(),e(".tabloophelperafter").focus(AudioEye.modals.continueOnNext),e(".tabloophelperbefore").focus(AudioEye.modals.continueOnPrev))})},continueOnNext:b,continueOnPrev:p,sourceIframe:r.iframes.getFrameFromWindow};return window.audioeye_test_mode&&(window.testScope.modals={enter_tabloop_state:a,exit_tabloop_state:n,handler:l,eventTargetOverride:d,isNextElementAHelper:u,continueOnPrev:p,continueOnNext:b,tabbableOrIframe:c,tabbableOrIframeButNotHelper:m}),v});